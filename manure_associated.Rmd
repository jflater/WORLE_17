---
title: "Analysis of WORLE 2017 soils and water 16s rRNA"
author: "Jared"
date: "6/20/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### First we read in the data, a R data structure of the phyloseq object       
```{r, echo = F}
library(phyloseq)
library(tidyverse)
library(gplots)
library(phylosmith)
```
```{r}
# source functions
source("code/functions.R")
```

```{r}
phy <- readRDS("./data/RDS/worle_with_meta.RDS")
colnames(sample_data(phy))
unique(phy@sam_data$day)
```
```{r}
hist(sample_sums(phy), breaks = 100)
```

### Get a list of ASVs from manure and soil before manure was applied
```{r}
manure_otus <- subset_samples(phy, matrix == "manure") %>%
  filter_taxa(function(x) sum(x) >= 1, T) %>%
  otu_table() %>%
  rownames()

cc <- subset_samples(phy, treatment == "no_manure_strip" | day == "b") %>%
  filter_taxa(function(x) sum(x) >= 1, T) %>%
  otu_table() %>%
  rownames()

vvv_diag <- venn(list("Manure_ASVs" = manure_otus, "Soil_ASVs" = cc))
manure_persitors <- attr(vvv_diag, "intersections")$Manure_ASVs 
```

### Plot relative abundance of only manure associated ASVs   
```{r}
# Check reads, I was under the impression that all samples had at least 10k
phy.OTU <- OTU_to_column(phy)
manure.phy <- subset_samples(phy.OTU, matrix == "soil") %>%
  filter_taxa(function(x) sum(x) >= 1, T) 

persistors.phy <- subset_taxa(manure.phy, OTUID %in% manure_persitors) %>%
  filter_taxa(function(x) sum(x) >= 5, T) 
persistors.phy
min(taxa_sums(persistors.phy))
max(taxa_sums(persistors.phy))
```

### Trying to get a good plot of the abundance of manure associated ASVs
```{r}
plot_bar(persistors.phy, x = "treatment", y = "Abundance")
```

